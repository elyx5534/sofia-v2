"""
HTML report generator for backtests using Jinja2
"""

import json
from datetime import datetime
from pathlib import Path
from typing import Any, Dict, Optional

import pandas as pd
from jinja2 import Template


class ReportGenerator:
    """Generate HTML reports for backtest results"""

    def __init__(self):
        self.template = self._load_template()
        self.reports_dir = Path("outputs/reports")
        self.reports_dir.mkdir(parents=True, exist_ok=True)

    def _load_template(self) -> Template:
        """Load HTML template"""
        template_str = '\n<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Backtest Report #{{ job_id }} - {{ strategy_name }}</title>\n    <style>\n        * { margin: 0; padding: 0; box-sizing: border-box; }\n        body {\n            font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, Oxygen, Ubuntu, sans-serif;\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            min-height: 100vh;\n            padding: 2rem;\n        }\n        .container {\n            max-width: 1200px;\n            margin: 0 auto;\n            background: white;\n            border-radius: 16px;\n            box-shadow: 0 20px 60px rgba(0,0,0,0.3);\n            overflow: hidden;\n        }\n        .header {\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            color: white;\n            padding: 2rem;\n        }\n        .header h1 {\n            font-size: 2rem;\n            margin-bottom: 0.5rem;\n        }\n        .header .meta {\n            opacity: 0.9;\n            font-size: 0.9rem;\n        }\n        .content {\n            padding: 2rem;\n        }\n        .metrics-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n            gap: 1.5rem;\n            margin-bottom: 2rem;\n        }\n        .metric-card {\n            background: #f7f9fc;\n            padding: 1.5rem;\n            border-radius: 8px;\n            border-left: 4px solid #667eea;\n        }\n        .metric-card .label {\n            color: #718096;\n            font-size: 0.875rem;\n            text-transform: uppercase;\n            letter-spacing: 0.05em;\n            margin-bottom: 0.5rem;\n        }\n        .metric-card .value {\n            font-size: 1.5rem;\n            font-weight: bold;\n            color: #2d3748;\n        }\n        .metric-card.positive .value { color: #48bb78; }\n        .metric-card.negative .value { color: #f56565; }\n        .section {\n            margin-bottom: 2rem;\n        }\n        .section h2 {\n            font-size: 1.5rem;\n            margin-bottom: 1rem;\n            color: #2d3748;\n            border-bottom: 2px solid #e2e8f0;\n            padding-bottom: 0.5rem;\n        }\n        .chart-container {\n            background: #f7f9fc;\n            padding: 1.5rem;\n            border-radius: 8px;\n            margin-bottom: 1.5rem;\n        }\n        #equityChart, #drawdownChart {\n            width: 100%;\n            height: 300px;\n        }\n        .trades-table {\n            width: 100%;\n            border-collapse: collapse;\n            font-size: 0.9rem;\n        }\n        .trades-table th {\n            background: #f7f9fc;\n            padding: 0.75rem;\n            text-align: left;\n            font-weight: 600;\n            color: #4a5568;\n            border-bottom: 2px solid #e2e8f0;\n        }\n        .trades-table td {\n            padding: 0.75rem;\n            border-bottom: 1px solid #e2e8f0;\n        }\n        .trades-table tr:hover {\n            background: #f7f9fc;\n        }\n        .win { color: #48bb78; font-weight: 600; }\n        .loss { color: #f56565; font-weight: 600; }\n        .params-box {\n            background: #f7f9fc;\n            padding: 1rem;\n            border-radius: 8px;\n            font-family: \'Courier New\', monospace;\n            font-size: 0.9rem;\n        }\n        .footer {\n            background: #f7f9fc;\n            padding: 1.5rem 2rem;\n            text-align: center;\n            color: #718096;\n            font-size: 0.875rem;\n        }\n    </style>\n    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>\n</head>\n<body>\n    <div class="container">\n        <div class="header">\n            <h1>Backtest Report #{{ job_id }}</h1>\n            <div class="meta">\n                <div>Strategy: {{ strategy_name }} | Symbol: {{ symbol }}</div>\n                <div>Generated: {{ generated_at }}</div>\n            </div>\n        </div>\n        \n        <div class="content">\n            <!-- Key Metrics -->\n            <div class="metrics-grid">\n                <div class="metric-card {{ \'positive\' if metrics.total_return > 0 else \'negative\' }}">\n                    <div class="label">Total Return</div>\n                    <div class="value">{{ "%.2f"|format(metrics.total_return) }}%</div>\n                </div>\n                <div class="metric-card">\n                    <div class="label">CAGR</div>\n                    <div class="value">{{ "%.2f"|format(metrics.cagr) }}%</div>\n                </div>\n                <div class="metric-card">\n                    <div class="label">Sharpe Ratio</div>\n                    <div class="value">{{ "%.2f"|format(metrics.sharpe_ratio) }}</div>\n                </div>\n                <div class="metric-card negative">\n                    <div class="label">Max Drawdown</div>\n                    <div class="value">-{{ "%.2f"|format(metrics.max_drawdown) }}%</div>\n                </div>\n                <div class="metric-card">\n                    <div class="label">Win Rate</div>\n                    <div class="value">{{ "%.1f"|format(metrics.win_rate) }}%</div>\n                </div>\n                <div class="metric-card">\n                    <div class="label">Total Trades</div>\n                    <div class="value">{{ metrics.total_trades }}</div>\n                </div>\n                <div class="metric-card">\n                    <div class="label">Avg Trade</div>\n                    <div class="value">{{ "%.2f"|format(metrics.avg_trade) }}%</div>\n                </div>\n                <div class="metric-card">\n                    <div class="label">MAR Ratio</div>\n                    <div class="value">{{ "%.2f"|format(metrics.mar_ratio) }}</div>\n                </div>\n            </div>\n            \n            <!-- Strategy Parameters -->\n            <div class="section">\n                <h2>Strategy Parameters</h2>\n                <div class="params-box">{{ params_json }}</div>\n            </div>\n            \n            <!-- Equity Curve -->\n            <div class="section">\n                <h2>Equity Curve</h2>\n                <div class="chart-container">\n                    <canvas id="equityChart"></canvas>\n                </div>\n            </div>\n            \n            <!-- Drawdown Chart -->\n            <div class="section">\n                <h2>Drawdown</h2>\n                <div class="chart-container">\n                    <canvas id="drawdownChart"></canvas>\n                </div>\n            </div>\n            \n            <!-- Recent Trades -->\n            {% if trades_data %}\n            <div class="section">\n                <h2>Recent Trades</h2>\n                <table class="trades-table">\n                    <thead>\n                        <tr>\n                            <th>Date</th>\n                            <th>Type</th>\n                            <th>Price</th>\n                            <th>Quantity</th>\n                            <th>P&L</th>\n                            <th>P&L %</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n                        {% for trade in trades_data[-20:] %}\n                        <tr>\n                            <td>{{ trade.timestamp }}</td>\n                            <td>{{ trade.type }}</td>\n                            <td>${{ "%.2f"|format(trade.price) }}</td>\n                            <td>{{ "%.4f"|format(trade.quantity) }}</td>\n                            <td class="{{ \'win\' if trade.pnl > 0 else \'loss\' if trade.pnl < 0 else \'\' }}">\n                                {% if trade.pnl is defined %}\n                                    ${{ "%.2f"|format(trade.pnl) }}\n                                {% else %}\n                                    -\n                                {% endif %}\n                            </td>\n                            <td class="{{ \'win\' if trade.pnl_pct > 0 else \'loss\' if trade.pnl_pct < 0 else \'\' }}">\n                                {% if trade.pnl_pct is defined %}\n                                    {{ "%.2f"|format(trade.pnl_pct) }}%\n                                {% else %}\n                                    -\n                                {% endif %}\n                            </td>\n                        </tr>\n                        {% endfor %}\n                    </tbody>\n                </table>\n            </div>\n            {% endif %}\n            \n            <!-- Performance Summary -->\n            <div class="section">\n                <h2>Performance Summary</h2>\n                <div class="metrics-grid">\n                    <div class="metric-card">\n                        <div class="label">Initial Capital</div>\n                        <div class="value">${{ "%.2f"|format(metrics.initial_capital) }}</div>\n                    </div>\n                    <div class="metric-card">\n                        <div class="label">Final Capital</div>\n                        <div class="value">${{ "%.2f"|format(metrics.final_capital) }}</div>\n                    </div>\n                    <div class="metric-card">\n                        <div class="label">Avg Win</div>\n                        <div class="value">{{ "%.2f"|format(metrics.avg_win) }}%</div>\n                    </div>\n                    <div class="metric-card">\n                        <div class="label">Avg Loss</div>\n                        <div class="value">{{ "%.2f"|format(metrics.avg_loss) }}%</div>\n                    </div>\n                    <div class="metric-card">\n                        <div class="label">Profit Factor</div>\n                        <div class="value">{{ "%.2f"|format(metrics.profit_factor) }}</div>\n                    </div>\n                    <div class="metric-card">\n                        <div class="label">Exposure Time</div>\n                        <div class="value">{{ "%.1f"|format(metrics.exposure_time) }}%</div>\n                    </div>\n                </div>\n            </div>\n        </div>\n        \n        <div class="footer">\n            Sofia V2 Backtest Report | Generated {{ generated_at }}\n        </div>\n    </div>\n    \n    <script>\n        // Equity Chart\n        const equityCtx = document.getElementById(\'equityChart\').getContext(\'2d\');\n        new Chart(equityCtx, {\n            type: \'line\',\n            data: {\n                labels: {{ equity_labels | safe }},\n                datasets: [{\n                    label: \'Equity\',\n                    data: {{ equity_values | safe }},\n                    borderColor: \'#667eea\',\n                    backgroundColor: \'rgba(102, 126, 234, 0.1)\',\n                    borderWidth: 2,\n                    fill: true,\n                    tension: 0.1\n                }]\n            },\n            options: {\n                responsive: true,\n                maintainAspectRatio: false,\n                plugins: {\n                    legend: { display: false }\n                },\n                scales: {\n                    y: {\n                        beginAtZero: false,\n                        ticks: {\n                            callback: function(value) {\n                                return \'$\' + value.toFixed(0);\n                            }\n                        }\n                    }\n                }\n            }\n        });\n        \n        // Drawdown Chart\n        const drawdownCtx = document.getElementById(\'drawdownChart\').getContext(\'2d\');\n        new Chart(drawdownCtx, {\n            type: \'line\',\n            data: {\n                labels: {{ equity_labels | safe }},\n                datasets: [{\n                    label: \'Drawdown\',\n                    data: {{ drawdown_values | safe }},\n                    borderColor: \'#f56565\',\n                    backgroundColor: \'rgba(245, 101, 101, 0.1)\',\n                    borderWidth: 2,\n                    fill: true,\n                    tension: 0.1\n                }]\n            },\n            options: {\n                responsive: true,\n                maintainAspectRatio: false,\n                plugins: {\n                    legend: { display: false }\n                },\n                scales: {\n                    y: {\n                        beginAtZero: true,\n                        ticks: {\n                            callback: function(value) {\n                                return value.toFixed(1) + \'%\';\n                            }\n                        }\n                    }\n                }\n            }\n        });\n    </script>\n</body>\n</html>\n        '
        return Template(template_str)

    def generate(
        self,
        job_id: int,
        strategy_name: str,
        params: Dict[str, Any],
        metrics: Dict[str, Any],
        equity_df: pd.DataFrame,
        trades_df: Optional[pd.DataFrame],
        symbol: str,
    ) -> Path:
        """
        Generate HTML report for backtest

        Returns:
            Path to generated HTML file
        """
        equity_labels = []
        equity_values = []
        drawdown_values = []
        if not equity_df.empty:
            sample_rate = max(1, len(equity_df) // 500)
            sampled_df = equity_df.iloc[::sample_rate]
            equity_labels = [str(idx)[:19] for idx in sampled_df.index]
            equity_values = sampled_df["equity"].tolist()
            rolling_max = sampled_df["equity"].cummax()
            drawdown = ((sampled_df["equity"] - rolling_max) / rolling_max * 100).fillna(0)
            drawdown_values = drawdown.tolist()
        trades_data = []
        if trades_df is not None and (not trades_df.empty):
            trades_data = trades_df.to_dict("records")
            for trade in trades_data:
                if "timestamp" in trade:
                    trade["timestamp"] = str(trade["timestamp"])[:19]
        html = self.template.render(
            job_id=job_id,
            strategy_name=strategy_name,
            symbol=symbol,
            params_json=json.dumps(params, indent=2),
            metrics=metrics,
            equity_labels=json.dumps(equity_labels),
            equity_values=json.dumps(equity_values),
            drawdown_values=json.dumps(drawdown_values),
            trades_data=trades_data,
            generated_at=datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        )
        report_path = self.reports_dir / f"{job_id}_report.html"
        with open(report_path, "w") as f:
            f.write(html)
        return report_path
