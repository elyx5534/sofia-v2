<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markets - Sofia V2</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#8b5cf6',
                    }
                }
            }
        }
    </script>
    
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .glass {
            background: rgba(15, 23, 42, 0.3);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-950 via-slate-900 to-gray-950">
    <!-- Top Navbar -->
    <nav class="fixed top-0 left-0 right-0 z-50 glass">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="/" class="text-xl font-bold text-white">
                        <i class="fas fa-robot text-blue-400 mr-2"></i>
                        Sofia V2
                    </a>
                </div>
                
                <!-- Nav Links -->
                <div class="hidden md:flex items-center space-x-6">
                    <a href="/dashboard" class="text-gray-300 hover:text-white">Dashboard</a>
                    <a href="/strategies" class="text-gray-300 hover:text-white">Strategies</a>
                    <a href="/backtests" class="text-gray-300 hover:text-white">Backtests</a>
                    <a href="/signals" class="text-gray-300 hover:text-white">Signals</a>
                    <a href="/markets" class="text-white font-semibold">Markets</a>
                    <a href="/settings" class="text-gray-300 hover:text-white">Settings</a>
                    <a href="/status" class="text-gray-300 hover:text-white">Status</a>
                </div>
                
                <!-- Right Actions -->
                <div class="flex items-center space-x-4">
                    <button class="text-gray-300 hover:text-white">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="text-gray-300 hover:text-white">
                        <i class="fas fa-user-circle text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="pt-20 px-6 py-6 max-w-7xl mx-auto" x-data="marketsApp()">
        <!-- Page Header -->
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-white mb-2">
                <i class="fas fa-chart-line mr-3 text-blue-400"></i>
                Markets
            </h1>
            <p class="text-gray-400">Real-time market data and trading</p>
        </div>
        
        <!-- Market Tabs -->
        <div class="mb-6">
            <div class="flex space-x-2">
                <button 
                    @click="activeTab = 'crypto'"
                    :class="activeTab === 'crypto' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-400'"
                    class="px-4 py-2 rounded-lg transition-colors"
                >
                    <i class="fas fa-bitcoin mr-2"></i>
                    Crypto
                </button>
                <button 
                    @click="activeTab = 'equities'"
                    :class="activeTab === 'equities' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-400'"
                    class="px-4 py-2 rounded-lg transition-colors"
                >
                    <i class="fas fa-chart-bar mr-2"></i>
                    Equities
                </button>
                <button 
                    @click="activeTab = 'indices'"
                    :class="activeTab === 'indices' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-400'"
                    class="px-4 py-2 rounded-lg transition-colors"
                >
                    <i class="fas fa-globe mr-2"></i>
                    Indices
                </button>
            </div>
        </div>
        
        <!-- Search and Filter -->
        <div class="glass rounded-xl p-4 mb-6">
            <div class="flex items-center space-x-4">
                <div class="flex-1">
                    <input 
                        type="text"
                        x-model="searchQuery"
                        @input="filterAssets()"
                        placeholder="Search symbols..."
                        class="w-full px-4 py-2 bg-gray-800/50 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                </div>
                
                <template x-if="activeTab === 'equities'">
                    <select 
                        x-model="selectedCategory"
                        @change="filterAssets()"
                        class="px-4 py-2 bg-gray-800/50 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                        <option value="">All Categories</option>
                        <option value="BIST30">BIST 30</option>
                        <option value="US_MEGA_TECH">US Tech</option>
                        <option value="US_FINANCE">US Finance</option>
                        <option value="US_HEALTHCARE">US Healthcare</option>
                        <option value="US_ENERGY">US Energy</option>
                        <option value="US_CONSUMER">US Consumer</option>
                        <option value="US_INDUSTRIAL">US Industrial</option>
                    </select>
                </template>
            </div>
        </div>
        
        <!-- Paper Trading Panel -->
        <div x-show="paperTradingEnabled" class="glass rounded-xl p-4 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-white">
                    <i class="fas fa-paper-plane text-yellow-400 mr-2"></i>
                    Paper Trading
                </h3>
                <div class="text-sm text-gray-400">
                    Balance: $<span x-text="paperBalance.toLocaleString()"></span>
                    | P&L: <span :class="totalPnL >= 0 ? 'text-green-400' : 'text-red-400'" x-text="totalPnL >= 0 ? '+' : ''" x-text="totalPnL.toFixed(2)"></span>
                </div>
            </div>
            
            <!-- Quick Order Panel -->
            <div class="grid grid-cols-4 gap-4">
                <input 
                    type="text"
                    x-model="orderSymbol"
                    placeholder="Symbol"
                    class="px-3 py-2 bg-gray-800/50 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <input 
                    type="number"
                    x-model="orderQuantity"
                    placeholder="Quantity"
                    min="0.001"
                    step="0.001"
                    class="px-3 py-2 bg-gray-800/50 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <button 
                    @click="executePaperOrder('buy')"
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                >
                    <i class="fas fa-arrow-up mr-2"></i>Buy
                </button>
                <button 
                    @click="executePaperOrder('sell')"
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                >
                    <i class="fas fa-arrow-down mr-2"></i>Sell
                </button>
            </div>
        </div>
        
        <!-- Market Data Table -->
        <div class="glass rounded-xl overflow-hidden">
            <table class="w-full">
                <thead class="bg-gray-900/50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Symbol</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Price</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">24h Change</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Volume</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-800">
                    <template x-for="asset in filteredAssets" :key="asset.symbol">
                        <tr class="hover:bg-gray-800/30" data-testid="market-row">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-white" x-text="asset.symbol"></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-400" x-text="asset.name"></div>
                                <div class="text-xs text-gray-500" x-text="asset.sector"></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <div class="text-sm font-mono text-white">
                                    $<span x-text="asset.price ? asset.price.toFixed(2) : 'Loading...'"></span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <div class="text-sm" :class="asset.change >= 0 ? 'text-green-400' : 'text-red-400'">
                                    <span x-text="asset.change >= 0 ? '+' : ''"></span>
                                    <span x-text="asset.change ? asset.change.toFixed(2) : '-'"></span>%
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <div class="text-sm text-gray-400" x-text="asset.volume ? asset.volume.toLocaleString() : '-'"></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <button 
                                    @click="setOrderSymbol(asset.symbol)"
                                    class="text-blue-400 hover:text-blue-300 mr-3"
                                    title="Trade"
                                >
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                                <button 
                                    @click="toggleWatchlist(asset.symbol)"
                                    class="hover:text-yellow-300"
                                    :class="watchlist.includes(asset.symbol) ? 'text-yellow-400' : 'text-gray-400'"
                                    title="Watchlist"
                                >
                                    <i class="fas fa-star"></i>
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
            
            <!-- Empty State -->
            <div x-show="filteredAssets.length === 0" class="p-8 text-center text-gray-400">
                <i class="fas fa-search text-4xl mb-4"></i>
                <p>No assets found</p>
            </div>
        </div>
        
        <!-- Positions Panel (Paper Trading) -->
        <div x-show="paperTradingEnabled && positions.length > 0" class="mt-6 glass rounded-xl p-6">
            <h3 class="text-lg font-semibold text-white mb-4" data-testid="open-positions-count">
                <i class="fas fa-briefcase text-purple-400 mr-2"></i>
                Open Positions (<span x-text="positions.length"></span>)
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <template x-for="position in positions" :key="position.symbol">
                    <div class="bg-gray-800/50 rounded-lg p-4">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="text-white font-medium" x-text="position.symbol"></div>
                                <div class="text-sm text-gray-400">
                                    <span x-text="position.quantity"></span> @ $<span x-text="position.avgPrice.toFixed(2)"></span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm" :class="position.pnl >= 0 ? 'text-green-400' : 'text-red-400'" data-testid="total-pnl">
                                    <span x-text="position.pnl >= 0 ? '+' : ''"></span>$<span x-text="Math.abs(position.pnl).toFixed(2)"></span>
                                </div>
                                <div class="text-xs text-gray-500">
                                    <span x-text="position.pnlPct.toFixed(2)"></span>%
                                </div>
                            </div>
                        </div>
                        <button 
                            @click="closePosition(position.symbol)"
                            class="w-full px-3 py-1 bg-red-600/20 text-red-400 rounded hover:bg-red-600/30 transition-colors text-sm"
                        >
                            Close Position
                        </button>
                    </div>
                </template>
            </div>
        </div>
    </div>
    
    <!-- Markets App -->
    <script>
        function marketsApp() {
            return {
                activeTab: 'crypto',
                searchQuery: '',
                selectedCategory: '',
                assets: [],
                filteredAssets: [],
                watchlist: JSON.parse(localStorage.getItem('watchlist') || '[]'),
                paperTradingEnabled: localStorage.getItem('paperTradingEnabled') === 'true',
                paperBalance: 100000,
                totalPnL: 0,
                positions: [],
                orderSymbol: '',
                orderQuantity: 1,
                apiUrl: localStorage.getItem('apiUrl') || 'http://127.0.0.1:8023',
                
                async init() {
                    await this.loadAssets();
                    if (this.paperTradingEnabled) {
                        await this.loadPositions();
                    }
                    // Refresh prices every 5 seconds
                    setInterval(() => this.refreshPrices(), 5000);
                },
                
                async loadAssets() {
                    if (this.activeTab === 'crypto') {
                        // Load crypto assets
                        this.assets = [
                            { symbol: 'BTC/USDT', name: 'Bitcoin', sector: 'Cryptocurrency', price: null, change: null, volume: null },
                            { symbol: 'ETH/USDT', name: 'Ethereum', sector: 'Cryptocurrency', price: null, change: null, volume: null },
                            { symbol: 'BNB/USDT', name: 'Binance Coin', sector: 'Cryptocurrency', price: null, change: null, volume: null },
                            { symbol: 'SOL/USDT', name: 'Solana', sector: 'Cryptocurrency', price: null, change: null, volume: null },
                            { symbol: 'ADA/USDT', name: 'Cardano', sector: 'Cryptocurrency', price: null, change: null, volume: null },
                        ];
                    } else if (this.activeTab === 'equities') {
                        // Load equity assets from API
                        try {
                            const response = await fetch(`${this.apiUrl}/assets/list?type=equity`);
                            const data = await response.json();
                            this.assets = data.assets || [];
                        } catch (error) {
                            console.error('Failed to load equities:', error);
                            this.assets = [];
                        }
                    } else if (this.activeTab === 'indices') {
                        // Load indices
                        this.assets = [
                            { symbol: '^GSPC', name: 'S&P 500', sector: 'Index', price: null, change: null, volume: null },
                            { symbol: '^DJI', name: 'Dow Jones', sector: 'Index', price: null, change: null, volume: null },
                            { symbol: '^IXIC', name: 'NASDAQ', sector: 'Index', price: null, change: null, volume: null },
                            { symbol: 'XU100.IS', name: 'BIST 100', sector: 'Index', price: null, change: null, volume: null },
                        ];
                    }
                    
                    this.filterAssets();
                    await this.refreshPrices();
                },
                
                filterAssets() {
                    let filtered = this.assets;
                    
                    // Apply search filter
                    if (this.searchQuery) {
                        const query = this.searchQuery.toLowerCase();
                        filtered = filtered.filter(a => 
                            a.symbol.toLowerCase().includes(query) || 
                            a.name.toLowerCase().includes(query)
                        );
                    }
                    
                    // Apply category filter (equities only)
                    if (this.selectedCategory && this.activeTab === 'equities') {
                        filtered = filtered.filter(a => a.category === this.selectedCategory);
                    }
                    
                    this.filteredAssets = filtered;
                },
                
                async refreshPrices() {
                    // Fetch prices for visible assets
                    const symbols = this.filteredAssets.slice(0, 20).map(a => a.symbol);
                    
                    if (symbols.length === 0) return;
                    
                    try {
                        // Different endpoints for different asset types
                        if (this.activeTab === 'crypto') {
                            // Use existing crypto price endpoints
                            for (let asset of this.filteredAssets) {
                                try {
                                    const response = await fetch(`${this.apiUrl}/api/trading/price/${asset.symbol}`);
                                    const data = await response.json();
                                    asset.price = data.price;
                                    asset.change = Math.random() * 10 - 5; // Mock change
                                } catch (error) {
                                    console.error(`Failed to fetch price for ${asset.symbol}:`, error);
                                }
                            }
                        } else if (this.activeTab === 'equities') {
                            // Use bulk quotes endpoint
                            const response = await fetch(`${this.apiUrl}/assets/quotes`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(symbols)
                            });
                            const data = await response.json();
                            
                            // Update prices
                            for (let quote of data.quotes || []) {
                                const asset = this.filteredAssets.find(a => a.symbol === quote.symbol);
                                if (asset) {
                                    asset.price = quote.price;
                                    asset.change = Math.random() * 10 - 5; // Mock change
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Failed to refresh prices:', error);
                    }
                },
                
                toggleWatchlist(symbol) {
                    const index = this.watchlist.indexOf(symbol);
                    if (index > -1) {
                        this.watchlist.splice(index, 1);
                    } else {
                        this.watchlist.push(symbol);
                    }
                    localStorage.setItem('watchlist', JSON.stringify(this.watchlist));
                },
                
                setOrderSymbol(symbol) {
                    this.orderSymbol = symbol;
                    // Scroll to order panel
                    window.scrollTo({ top: 200, behavior: 'smooth' });
                },
                
                async executePaperOrder(side) {
                    if (!this.orderSymbol || !this.orderQuantity) {
                        alert('Please enter symbol and quantity');
                        return;
                    }
                    
                    try {
                        // Get current price
                        const asset = this.filteredAssets.find(a => a.symbol === this.orderSymbol);
                        if (!asset || !asset.price) {
                            alert('Price not available for ' + this.orderSymbol);
                            return;
                        }
                        
                        const response = await fetch(`${this.apiUrl}/paper/orders`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                symbol: this.orderSymbol,
                                side: side,
                                qty: parseFloat(this.orderQuantity),
                                price: asset.price
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            this.showNotification(`Order executed: ${side} ${this.orderQuantity} ${this.orderSymbol}`);
                            await this.loadPositions();
                            
                            // Clear order form
                            this.orderSymbol = '';
                            this.orderQuantity = 1;
                        } else {
                            const error = await response.json();
                            alert('Order failed: ' + error.detail);
                        }
                    } catch (error) {
                        console.error('Failed to execute order:', error);
                        alert('Failed to execute order');
                    }
                },
                
                async loadPositions() {
                    try {
                        const response = await fetch(`${this.apiUrl}/paper/positions`);
                        const positions = await response.json();
                        
                        // Calculate P&L for display
                        this.positions = positions.map(pos => ({
                            ...pos,
                            avgPrice: parseFloat(pos.avg_price),
                            quantity: parseFloat(pos.quantity),
                            pnl: parseFloat(pos.unrealized_pnl || 0),
                            pnlPct: ((parseFloat(pos.last_price) - parseFloat(pos.avg_price)) / parseFloat(pos.avg_price)) * 100
                        }));
                        
                        // Calculate total P&L
                        const pnlResponse = await fetch(`${this.apiUrl}/paper/pnl`);
                        const pnlData = await pnlResponse.json();
                        this.totalPnL = parseFloat(pnlData.total_pnl || 0);
                        this.paperBalance = parseFloat(pnlData.cash_balance || 100000);
                    } catch (error) {
                        console.error('Failed to load positions:', error);
                    }
                },
                
                async closePosition(symbol) {
                    const position = this.positions.find(p => p.symbol === symbol);
                    if (!position) return;
                    
                    await this.executePaperOrder('sell');
                },
                
                showNotification(message) {
                    const notification = document.createElement('div');
                    notification.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                    notification.textContent = message;
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                }
            }
        }
    </script>
</body>
</html>