<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ symbol }} Analysis - Sofia V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-bold">{{ symbol }} Analysis</h1>
            <div class="flex space-x-4">
                <a href="/" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">Home</a>
                <a href="/showcase/{{ symbol }}" class="bg-green-600 px-4 py-2 rounded hover:bg-green-700">Showcase</a>
            </div>
        </div>

        <!-- Price and Status -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-lg font-semibold mb-2">Current Price</h2>
                <div class="text-3xl font-bold" id="current-price">${{ price|default(0) }}</div>
                <div class="text-sm text-gray-400 mt-2">
                    Source: <span id="data-source">{{ source|default('N/A') }}</span>
                    <br>Freshness: <span id="data-freshness">{{ freshness|default('N/A') }}s</span>
                </div>
            </div>
            
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-lg font-semibold mb-2">24h Change</h2>
                <div class="text-3xl font-bold text-green-500">+2.45%</div>
                <div class="text-sm text-gray-400 mt-2">Volume: $28.5B</div>
            </div>
            
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-lg font-semibold mb-2">Data Status</h2>
                <div id="ws-status" class="text-lg">
                    WebSocket: <span class="font-bold">{{ 'Connected' if ws_connected else 'Disconnected' }}</span>
                </div>
                <div class="text-sm text-gray-400 mt-2">
                    Updates: <span id="tick-count">0</span> ticks
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="bg-gray-800 p-6 rounded-lg mb-8">
            <h2 class="text-xl font-semibold mb-4">Price Chart</h2>
            <div id="chart" style="height: 400px;"></div>
        </div>

        <!-- Technical Indicators -->
        <div class="bg-gray-800 p-6 rounded-lg mb-8">
            <h2 class="text-xl font-semibold mb-4">Technical Indicators</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                    <div class="text-sm text-gray-400">RSI (14)</div>
                    <div class="text-lg font-bold">{{ rsi|default(50) }}</div>
                </div>
                <div>
                    <div class="text-sm text-gray-400">SMA (20)</div>
                    <div class="text-lg font-bold">${{ sma_20|default(0) }}</div>
                </div>
                <div>
                    <div class="text-sm text-gray-400">MACD</div>
                    <div class="text-lg font-bold text-green-500">Bullish</div>
                </div>
                <div>
                    <div class="text-sm text-gray-400">Bollinger</div>
                    <div class="text-lg font-bold">Middle Band</div>
                </div>
            </div>
        </div>

        <!-- Strategy Performance -->
        <div class="bg-gray-800 p-6 rounded-lg mb-8">
            <h2 class="text-xl font-semibold mb-4">Best Strategy Performance</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <div class="text-sm text-gray-400">Strategy</div>
                    <div class="text-lg font-bold">SMA Crossover</div>
                </div>
                <div>
                    <div class="text-sm text-gray-400">Return</div>
                    <div class="text-lg font-bold text-green-500">+45.6%</div>
                </div>
                <div>
                    <div class="text-sm text-gray-400">Sharpe Ratio</div>
                    <div class="text-lg font-bold">1.23</div>
                </div>
            </div>
        </div>

        <!-- News -->
        <div class="bg-gray-800 p-6 rounded-lg mb-8">
            <h2 class="text-xl font-semibold mb-4">Latest News</h2>
            <div class="space-y-4">
                {% for article in news %}
                <div class="border-l-4 border-blue-500 pl-4">
                    <h3 class="font-semibold">{{ article.title }}</h3>
                    <p class="text-sm text-gray-400">{{ article.source }} - {{ article.time }}</p>
                </div>
                {% else %}
                <p class="text-gray-400">No news available</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        // Create chart
        const chartElement = document.getElementById('chart');
        const chart = LightweightCharts.createChart(chartElement, {
            layout: {
                background: { color: '#1f2937' },
                textColor: '#d1d5db',
            },
            grid: {
                vertLines: { color: '#374151' },
                horzLines: { color: '#374151' },
            },
        });

        const candlestickSeries = chart.addCandlestickSeries({
            upColor: '#10b981',
            downColor: '#ef4444',
            borderVisible: false,
            wickUpColor: '#10b981',
            wickDownColor: '#ef4444',
        });

        // Sample data
        const data = [
            { time: '2024-01-01', open: 65000, high: 68000, low: 64000, close: 67000 },
            { time: '2024-01-02', open: 67000, high: 69000, low: 66000, close: 68000 },
            { time: '2024-01-03', open: 68000, high: 69500, low: 67000, close: 67500 },
            { time: '2024-01-04', open: 67500, high: 68500, low: 66500, close: 68000 },
            { time: '2024-01-05', open: 68000, high: 69000, low: 67500, close: 67845 },
        ];
        candlestickSeries.setData(data);
        chart.timeScale().fitContent();

        // Update price periodically
        async function updatePrice() {
            try {
                const response = await fetch('/price/{{ symbol }}');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('current-price').textContent = `$${data.price.toFixed(2)}`;
                    document.getElementById('data-source').textContent = data.source;
                    document.getElementById('data-freshness').textContent = data.freshness.toFixed(1) + 's';
                }
            } catch (error) {
                console.error('Failed to update price:', error);
            }
        }

        // Update metrics
        async function updateMetrics() {
            try {
                const response = await fetch('/metrics');
                if (response.ok) {
                    const metrics = await response.json();
                    const wsStatus = metrics.websocket_connected ? 'Connected' : 'Disconnected';
                    document.getElementById('ws-status').innerHTML = `WebSocket: <span class="font-bold">${wsStatus}</span>`;
                }
            } catch (error) {
                console.error('Failed to update metrics:', error);
            }
        }

        // Update every 5 seconds
        setInterval(updatePrice, 5000);
        setInterval(updateMetrics, 10000);
        
        // Initial update
        updatePrice();
        updateMetrics();
    </script>
</body>
</html>