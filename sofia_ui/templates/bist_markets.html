{% extends "base.html" %}

{% block title %}BIST - Borsa İstanbul | Sofia V2{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900">
    <!-- Header -->
    <div class="bg-black/50 backdrop-blur-sm border-b border-gray-700">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-white mb-2">
                        <i class="fas fa-chart-line text-red-500 mr-3"></i>
                        Borsa İstanbul
                    </h1>
                    <p class="text-gray-400">{{ stocks|length }} Hisse Senedi • Canlı Fiyatlar</p>
                </div>
                <div class="text-right">
                    <div class="bg-gray-800 rounded-lg p-4">
                        <div class="text-sm text-gray-400 mb-1">BIST 100</div>
                        <div class="text-2xl font-bold text-white" id="bist100-value">{{ "{:,.2f}".format(bist100.value) }}</div>
                        <div class="flex items-center" id="bist100-change">
                            {% if bist100.change > 0 %}
                            <i class="fas fa-arrow-up text-green-500 mr-2"></i>
                            <span class="text-green-500">+{{ "{:,.2f}".format(bist100.change) }} (%{{ bist100.change_percent }})</span>
                            {% else %}
                            <i class="fas fa-arrow-down text-red-500 mr-2"></i>
                            <span class="text-red-500">{{ "{:,.2f}".format(bist100.change) }} (%{{ bist100.change_percent }})</span>
                            {% endif %}
                        </div>
                        <div class="text-xs text-gray-400 mt-1">Son Güncelleme: <span id="last-update">{{ bist100.last_updated }}</span></div>
                    </div>
                </div>
            </div>
            
            <!-- Gerçek Veri Butonu -->
            <div class="mt-4">
                <button onclick="fetchRealData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-sync-alt mr-2" id="refresh-icon"></i>
                    Gerçek Verileri Yükle
                </button>
                <span id="loading-status" class="ml-3 text-yellow-400 hidden">
                    <i class="fas fa-spinner fa-spin mr-2"></i>Veriler yükleniyor...
                </span>
                <span id="success-status" class="ml-3 text-green-400 hidden">
                    <i class="fas fa-check-circle mr-2"></i>Gerçek veriler yüklendi!
                </span>
            </div>
        </div>
    </div>

    <!-- Market Stats -->
    <div class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-lg p-4 border border-gray-700">
                <div class="text-sm text-gray-400 mb-1">İşlem Hacmi</div>
                <div class="text-xl font-bold text-white" id="total-volume">{{ bist100.volume }}</div>
            </div>
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-lg p-4 border border-gray-700">
                <div class="text-sm text-gray-400 mb-1">Yükselen</div>
                <div class="text-xl font-bold text-green-500" id="rising-count">{{ stocks|selectattr('change_percent', '>', 0)|list|length }}</div>
            </div>
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-lg p-4 border border-gray-700">
                <div class="text-sm text-gray-400 mb-1">Düşen</div>
                <div class="text-xl font-bold text-red-500" id="falling-count">{{ stocks|selectattr('change_percent', '<', 0)|list|length }}</div>
            </div>
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-lg p-4 border border-gray-700">
                <div class="text-sm text-gray-400 mb-1">Veri Kaynağı</div>
                <div class="text-xl font-bold text-white" id="data-source">Mock Data</div>
            </div>
        </div>

        <!-- Top Movers -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Top Gainers -->
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-lg p-6 border border-gray-700">
                <h3 class="text-lg font-bold text-white mb-4">
                    <i class="fas fa-trending-up text-green-500 mr-2"></i>
                    En Çok Yükselenler
                </h3>
                <div class="space-y-3" id="top-gainers">
                    {% for stock in top_gainers %}
                    <div class="flex justify-between items-center bg-gray-900/50 rounded p-3">
                        <div>
                            <span class="font-semibold text-white">{{ stock.symbol }}</span>
                            <span class="text-sm text-gray-400 ml-2">{{ stock.name[:20] }}</span>
                        </div>
                        <div class="text-right">
                            <div class="text-white">₺{{ "{:,.2f}".format(stock.price) }}</div>
                            <div class="text-green-500 text-sm">+%{{ "{:.2f}".format(stock.change_percent) }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Top Losers -->
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-lg p-6 border border-gray-700">
                <h3 class="text-lg font-bold text-white mb-4">
                    <i class="fas fa-trending-down text-red-500 mr-2"></i>
                    En Çok Düşenler
                </h3>
                <div class="space-y-3" id="top-losers">
                    {% for stock in top_losers %}
                    <div class="flex justify-between items-center bg-gray-900/50 rounded p-3">
                        <div>
                            <span class="font-semibold text-white">{{ stock.symbol }}</span>
                            <span class="text-sm text-gray-400 ml-2">{{ stock.name[:20] }}</span>
                        </div>
                        <div class="text-right">
                            <div class="text-white">₺{{ "{:,.2f}".format(stock.price) }}</div>
                            <div class="text-red-500 text-sm">%{{ "{:.2f}".format(stock.change_percent) }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- All Stocks Table -->
        <div class="bg-gray-800/50 backdrop-blur-sm rounded-lg p-6 border border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">
                    <i class="fas fa-table mr-2"></i>
                    Tüm Hisseler
                </h3>
                <input type="text" id="stockSearch" placeholder="Hisse ara..." 
                       class="bg-gray-900 text-white px-4 py-2 rounded border border-gray-600 focus:border-blue-500 focus:outline-none">
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm" id="stocks-table">
                    <thead class="text-left text-gray-400 border-b border-gray-700">
                        <tr>
                            <th class="pb-3">Sembol</th>
                            <th class="pb-3">Şirket</th>
                            <th class="pb-3">Sektör</th>
                            <th class="pb-3 text-right">Fiyat (₺)</th>
                            <th class="pb-3 text-right">Değişim</th>
                            <th class="pb-3 text-right">Değişim %</th>
                            <th class="pb-3 text-right">Hacim</th>
                            <th class="pb-3 text-right">Piyasa Değeri (M₺)</th>
                            <th class="pb-3 text-right">F/K</th>
                            <th class="pb-3 text-right">Temettü %</th>
                        </tr>
                    </thead>
                    <tbody class="text-white" id="stocks-tbody">
                        {% for stock in stocks %}
                        <tr class="border-b border-gray-800 hover:bg-gray-900/50 transition-colors stock-row" data-symbol="{{ stock.symbol }}">
                            <td class="py-3 font-semibold">
                                <a href="/bist/{{ stock.symbol }}" class="text-blue-400 hover:text-blue-300">
                                    {{ stock.symbol }}
                                </a>
                            </td>
                            <td class="py-3 text-gray-300">{{ stock.name }}</td>
                            <td class="py-3 text-gray-400 text-xs">{{ stock.sector }}</td>
                            <td class="py-3 text-right stock-price">{{ "{:,.2f}".format(stock.price) }}</td>
                            <td class="py-3 text-right stock-change">
                                {% if stock.change > 0 %}
                                <span class="text-green-500">+{{ "{:,.2f}".format(stock.change) }}</span>
                                {% else %}
                                <span class="text-red-500">{{ "{:,.2f}".format(stock.change) }}</span>
                                {% endif %}
                            </td>
                            <td class="py-3 text-right stock-change-percent">
                                {% if stock.change_percent > 0 %}
                                <span class="bg-green-500/20 text-green-500 px-2 py-1 rounded">
                                    +{{ "{:.2f}".format(stock.change_percent) }}%
                                </span>
                                {% else %}
                                <span class="bg-red-500/20 text-red-500 px-2 py-1 rounded">
                                    {{ "{:.2f}".format(stock.change_percent) }}%
                                </span>
                                {% endif %}
                            </td>
                            <td class="py-3 text-right text-gray-400 stock-volume">{{ "{:,}".format(stock.volume) }}</td>
                            <td class="py-3 text-right text-gray-400">{{ "{:,.0f}".format(stock.market_cap) }}</td>
                            <td class="py-3 text-right text-gray-400">
                                {% if stock.pe_ratio %}{{ "{:.2f}".format(stock.pe_ratio) }}{% else %}-{% endif %}
                            </td>
                            <td class="py-3 text-right text-gray-400">
                                {% if stock.dividend_yield > 0 %}{{ "{:.2f}".format(stock.dividend_yield) }}%{% else %}-{% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="mt-8 flex gap-4 justify-center">
            <a href="/bist/analysis" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-colors">
                <i class="fas fa-chart-bar mr-2"></i>
                Günlük Analiz
            </a>
            <a href="/portfolio" class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition-colors">
                <i class="fas fa-briefcase mr-2"></i>
                Portföyüm
            </a>
            <button onclick="fetchRealData()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-colors">
                <i class="fas fa-sync-alt mr-2"></i>
                Verileri Güncelle
            </button>
        </div>
    </div>
</div>

<script>
// Search functionality
document.getElementById('stockSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.stock-row');
    
    rows.forEach(row => {
        const symbol = row.querySelector('td:first-child').textContent.toLowerCase();
        const name = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
        
        if (symbol.includes(searchTerm) || name.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Gerçek veri çekme fonksiyonu
async function fetchRealData() {
    const loadingStatus = document.getElementById('loading-status');
    const successStatus = document.getElementById('success-status');
    const refreshIcon = document.getElementById('refresh-icon');
    const dataSource = document.getElementById('data-source');
    
    // Add spin animation to refresh icon
    if (refreshIcon) {
        refreshIcon.classList.add('fa-spin');
    }
    
    // UI durumunu güncelle
    loadingStatus.classList.remove('hidden');
    successStatus.classList.add('hidden');
    refreshIcon.classList.add('fa-spin');
    
    try {
        // Gerçek veri API'sini çağır
        const response = await fetch('/api/bist/real-data');
        const data = await response.json();
        
        if (data.stocks && data.stocks.length > 0) {
            // Tabloyu güncelle
            updateStocksTable(data.stocks);
            
            // BIST 100 güncelle
            if (data.bist100) {
                updateBIST100(data.bist100);
            }
            
            // Top movers güncelle
            updateTopMovers(data.stocks);
            
            // İstatistikleri güncelle
            updateStats(data.stocks);
            
            // Başarı mesajı
            loadingStatus.classList.add('hidden');
            successStatus.classList.remove('hidden');
            dataSource.textContent = 'Yahoo Finance';
            
            setTimeout(() => {
                successStatus.classList.add('hidden');
            }, 3000);
        }
    } catch (error) {
        console.error('Veri çekme hatası:', error);
        loadingStatus.textContent = 'Veri çekilemedi!';
        loadingStatus.classList.remove('text-yellow-400');
        loadingStatus.classList.add('text-red-400');
        
        setTimeout(() => {
            loadingStatus.classList.add('hidden');
            loadingStatus.classList.remove('text-red-400');
            loadingStatus.classList.add('text-yellow-400');
            loadingStatus.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Veriler yükleniyor...';
        }, 3000);
    } finally {
        refreshIcon.classList.remove('fa-spin');
    }
}

function updateStocksTable(stocks) {
    const tbody = document.getElementById('stocks-tbody');
    
    stocks.forEach(stock => {
        const row = tbody.querySelector(`tr[data-symbol="${stock.symbol}"]`);
        if (row) {
            // Fiyat güncelle
            const priceCell = row.querySelector('.stock-price');
            if (priceCell) priceCell.textContent = stock.price.toFixed(2);
            
            // Değişim güncelle
            const changeCell = row.querySelector('.stock-change');
            if (changeCell) {
                const changeSpan = stock.change > 0 
                    ? `<span class="text-green-500">+${stock.change.toFixed(2)}</span>`
                    : `<span class="text-red-500">${stock.change.toFixed(2)}</span>`;
                changeCell.innerHTML = changeSpan;
            }
            
            // Yüzde değişim güncelle
            const percentCell = row.querySelector('.stock-change-percent');
            if (percentCell) {
                const percentSpan = stock.change_percent > 0
                    ? `<span class="bg-green-500/20 text-green-500 px-2 py-1 rounded">+${stock.change_percent.toFixed(2)}%</span>`
                    : `<span class="bg-red-500/20 text-red-500 px-2 py-1 rounded">${stock.change_percent.toFixed(2)}%</span>`;
                percentCell.innerHTML = percentSpan;
            }
            
            // Hacim güncelle
            const volumeCell = row.querySelector('.stock-volume');
            if (volumeCell) volumeCell.textContent = stock.volume.toLocaleString();
        }
    });
}

function updateBIST100(bist100) {
    document.getElementById('bist100-value').textContent = bist100.value.toFixed(2);
    
    const changeDiv = document.getElementById('bist100-change');
    const changeHTML = bist100.change > 0
        ? `<i class="fas fa-arrow-up text-green-500 mr-2"></i><span class="text-green-500">+${bist100.change.toFixed(2)} (${bist100.change_percent.toFixed(2)}%)</span>`
        : `<i class="fas fa-arrow-down text-red-500 mr-2"></i><span class="text-red-500">${bist100.change.toFixed(2)} (${bist100.change_percent.toFixed(2)}%)</span>`;
    changeDiv.innerHTML = changeHTML;
    
    document.getElementById('last-update').textContent = bist100.last_updated;
}

function updateTopMovers(stocks) {
    // Sırala
    const sorted = [...stocks].sort((a, b) => b.change_percent - a.change_percent);
    const gainers = sorted.slice(0, 5);
    const losers = sorted.slice(-5).reverse();
    
    // Top gainers güncelle
    const gainersDiv = document.getElementById('top-gainers');
    gainersDiv.innerHTML = gainers.map(stock => `
        <div class="flex justify-between items-center bg-gray-900/50 rounded p-3">
            <div>
                <span class="font-semibold text-white">${stock.symbol}</span>
                <span class="text-sm text-gray-400 ml-2">${stock.name.substring(0, 20)}</span>
            </div>
            <div class="text-right">
                <div class="text-white">₺${stock.price.toFixed(2)}</div>
                <div class="text-green-500 text-sm">+${stock.change_percent.toFixed(2)}%</div>
            </div>
        </div>
    `).join('');
    
    // Top losers güncelle
    const losersDiv = document.getElementById('top-losers');
    losersDiv.innerHTML = losers.map(stock => `
        <div class="flex justify-between items-center bg-gray-900/50 rounded p-3">
            <div>
                <span class="font-semibold text-white">${stock.symbol}</span>
                <span class="text-sm text-gray-400 ml-2">${stock.name.substring(0, 20)}</span>
            </div>
            <div class="text-right">
                <div class="text-white">₺${stock.price.toFixed(2)}</div>
                <div class="text-red-500 text-sm">${stock.change_percent.toFixed(2)}%</div>
            </div>
        </div>
    `).join('');
}

function updateStats(stocks) {
    const rising = stocks.filter(s => s.change_percent > 0).length;
    const falling = stocks.filter(s => s.change_percent < 0).length;
    
    document.getElementById('rising-count').textContent = rising;
    document.getElementById('falling-count').textContent = falling;
}

// Otomatik veri yenileme
let autoRefreshInterval;

function startAutoRefresh() {
    // İlk yükleme
    fetchRealData();
    
    // 30 saniyede bir güncelle
    autoRefreshInterval = setInterval(() => {
        console.log('Otomatik veri güncelleme...');
        fetchRealData();
    }, 30000); // 30 saniye
}

// Sayfa yüklendiğinde otomatik olarak gerçek veri çek
window.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        console.log('Gerçek veriler yükleniyor ve otomatik güncelleme başlatılıyor...');
        startAutoRefresh();
    }, 1000);
});

// Sayfa kapanırken interval'i temizle
window.addEventListener('beforeunload', () => {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});
</script>
{% endblock %}