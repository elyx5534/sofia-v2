<<<<<<< HEAD
ï»¿{% extends "base.html" %}
=======
{% extends "base.html" %}
>>>>>>> 96de1d9

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-950 via-slate-900 to-gray-950" x-data="marketsApp()">
    <!-- Header Stats -->
    <div class="px-6 py-4 border-b border-gray-800/50 backdrop-blur-xl bg-gray-900/40">
        <div class="max-w-[1920px] mx-auto">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-2xl font-bold text-white flex items-center">
                    <i class="fas fa-coins mr-3 text-yellow-400"></i>
                    Crypto Markets
                </h1>
                <div class="flex items-center space-x-4">
                    <div class="text-sm">
                        <span class="text-gray-400">Total Market Cap:</span>
                        <span class="text-white font-semibold ml-2">$2.42T</span>
                        <span class="text-emerald-400 ml-2">+2.4%</span>
                    </div>
                    <div class="text-sm">
                        <span class="text-gray-400">24h Volume:</span>
                        <span class="text-white font-semibold ml-2">$84.3B</span>
                    </div>
                    <div class="text-sm">
                        <span class="text-gray-400">BTC Dominance:</span>
                        <span class="text-white font-semibold ml-2">52.4%</span>
                    </div>
                </div>
            </div>

            <!-- Category Tabs -->
            <div class="flex items-center space-x-2 overflow-x-auto pb-2">
                <button @click="selectedCategory = 'all'"
                        :class="selectedCategory === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap">
                    <i class="fas fa-th mr-2"></i>All Coins
                </button>
                <button @click="selectedCategory = 'trending'"
                        :class="selectedCategory === 'trending' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap">
                    <i class="fas fa-fire mr-2 text-orange-400"></i>Trending
                </button>
                <button @click="selectedCategory = 'defi'"
                        :class="selectedCategory === 'defi' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap">
                    <i class="fas fa-chart-pie mr-2"></i>DeFi
                </button>
                <button @click="selectedCategory = 'gaming'"
                        :class="selectedCategory === 'gaming' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap">
                    <i class="fas fa-gamepad mr-2"></i>Gaming
                </button>
                <button @click="selectedCategory = 'layer1'"
                        :class="selectedCategory === 'layer1' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap">
                    <i class="fas fa-layer-group mr-2"></i>Layer 1
                </button>
                <button @click="selectedCategory = 'layer2'"
                        :class="selectedCategory === 'layer2' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap">
                    <i class="fas fa-clone mr-2"></i>Layer 2
                </button>
                <button @click="selectedCategory = 'meme'"
                        :class="selectedCategory === 'meme' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap">
                    <i class="fas fa-laugh mr-2"></i>Meme
                </button>
                <button @click="selectedCategory = 'ai'"
                        :class="selectedCategory === 'ai' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap">
                    <i class="fas fa-robot mr-2"></i>AI
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="px-6 py-6 max-w-[1920px] mx-auto">
        <!-- Search and Filters -->
        <div class="mb-6 flex flex-col md:flex-row gap-4">
            <div class="flex-1">
                <div class="relative">
                    <input type="text"
                           x-model="searchQuery"
                           placeholder="Search coins by name or symbol..."
                           class="w-full px-4 py-3 pl-12 bg-gray-900/60 border border-gray-800 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 transition-all">
                    <i class="fas fa-search absolute left-4 top-4 text-gray-400"></i>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <select x-model="sortBy" class="px-4 py-3 bg-gray-900/60 border border-gray-800 rounded-xl text-white focus:outline-none focus:border-blue-500">
                    <option value="market_cap">Market Cap</option>
                    <option value="price">Price</option>
                    <option value="change">24h Change</option>
                    <option value="volume">Volume</option>
                </select>
                <button @click="viewMode = viewMode === 'grid' ? 'list' : 'grid'"
                        class="px-4 py-3 bg-gray-900/60 border border-gray-800 rounded-xl text-white hover:bg-gray-800 transition-all">
                    <i :class="viewMode === 'grid' ? 'fas fa-list' : 'fas fa-th-large'"></i>
                </button>
            </div>
        </div>

        <!-- Grid View -->
        <div x-show="viewMode === 'grid'" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
            <template x-for="coin in filteredCoins" :key="coin.symbol">
                <div class="bg-gray-900/60 backdrop-blur-xl rounded-xl border border-gray-800/50 p-4 hover:border-gray-700 transition-all cursor-pointer group"
                     @click="window.location.href = `/assets/${coin.symbol}`">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-lg flex items-center justify-center bg-gray-500/20">
                                <template x-if="coin.icon">
                                    <i :class="coin.icon + ' text-lg'" :style="`color: ${getColorCode(coin.color)}`"></i>
                                </template>
                                <template x-if="!coin.icon">
                                    <span class="text-white font-bold text-sm" x-text="coin.symbol.substring(0, 2)"></span>
                                </template>
                            </div>
                            <div>
                                <div class="text-white font-semibold" x-text="coin.symbol ? coin.symbol.toUpperCase() : ''"></div>
                                <div class="text-xs text-gray-500" x-text="coin.name"></div>
                            </div>
                        </div>
                        <div class="text-xs px-2 py-1 bg-gray-800 rounded-full text-gray-400">
                            #<span x-text="coin.market_cap_rank || coin.rank"></span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="text-xl font-bold text-white">
                            $<span x-text="formatPrice(coin.current_price || coin.price)"></span>
                        </div>
                        <div class="text-sm mt-1"
                             :class="(coin.price_change_percentage_24h || coin.change_percent) >= 0 ? 'text-emerald-400' : 'text-red-400'">
                            <i :class="(coin.price_change_percentage_24h || coin.change_percent) >= 0 ? 'fas fa-arrow-up' : 'fas fa-arrow-down'" class="mr-1"></i>
                            <span x-text="Math.abs(coin.price_change_percentage_24h || coin.change_percent || 0).toFixed(2)"></span>%
                        </div>
                    </div>

                    <div class="h-16 mb-3">
                        <canvas :id="'chart-' + coin.symbol.replace('-USD', '')"></canvas>
                    </div>

                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div>
                            <span class="text-gray-500">Volume:</span>
                            <span class="text-white ml-1" x-text="coin.volume"></span>
                        </div>
                        <div>
                            <span class="text-gray-500">MCap:</span>
                            <span class="text-white ml-1">$<span x-text="formatMarketCap(coin.market_cap)"></span></span>
                        </div>
                    </div>

                    <div class="mt-3 pt-3 border-t border-gray-800/50 flex items-center justify-between">
                        <button @click.stop="addToWatchlist(coin)"
                                class="text-gray-400 hover:text-yellow-400 transition-colors">
                            <i class="far fa-star"></i>
                        </button>
                        <button @click.stop="openTradeModal(coin)"
                                class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded-lg transition-all">
                            Trade
                        </button>
                    </div>
                </div>
            </template>
        </div>

        <!-- List View -->
        <div x-show="viewMode === 'list'" class="bg-gray-900/60 backdrop-blur-xl rounded-xl border border-gray-800/50 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-800/50">
                        <tr class="text-left text-sm text-gray-400">
                            <th class="px-4 py-3">#</th>
                            <th class="px-4 py-3">Name</th>
                            <th class="px-4 py-3 text-right">Price</th>
                            <th class="px-4 py-3 text-right">24h %</th>
                            <th class="px-4 py-3 text-right">7d %</th>
                            <th class="px-4 py-3 text-right">Market Cap</th>
                            <th class="px-4 py-3 text-right">Volume(24h)</th>
                            <th class="px-4 py-3 text-center">Last 7 Days</th>
                            <th class="px-4 py-3 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-800/50">
                        <template x-for="coin in filteredCoins" :key="coin.symbol">
                            <tr class="hover:bg-gray-800/30 cursor-pointer transition-all"
                                @click="window.location.href = `/assets/${coin.symbol}`">
                                <td class="px-4 py-3 text-gray-400" x-text="coin.rank"></td>
                                <td class="px-4 py-3">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-gray-500/20">
                                            <template x-if="coin.icon">
                                                <i :class="coin.icon" :style="`color: ${getColorCode(coin.color)}`"></i>
                                            </template>
                                            <template x-if="!coin.icon">
                                                <span class="text-white font-bold text-xs" x-text="coin.symbol.substring(0, 2)"></span>
                                            </template>
                                        </div>
                                        <div>
                                            <div class="text-white font-medium" x-text="coin.name"></div>
                                            <div class="text-xs text-gray-500" x-text="coin.symbol"></div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-right text-white font-medium">
                                    $<span x-text="formatPrice(coin.price)"></span>
                                </td>
                                <td class="px-4 py-3 text-right"
                                    :class="coin.change_percent >= 0 ? 'text-emerald-400' : 'text-red-400'">
                                    <i :class="coin.change_percent >= 0 ? 'fas fa-arrow-up' : 'fas fa-arrow-down'" class="mr-1 text-xs"></i>
                                    <span x-text="Math.abs(coin.change_percent).toFixed(2)"></span>%
                                </td>
                                <td class="px-4 py-3 text-right"
                                    :class="coin.change_7d >= 0 ? 'text-emerald-400' : 'text-red-400'">
                                    <span x-text="(coin.change_7d || 0).toFixed(2)"></span>%
                                </td>
                                <td class="px-4 py-3 text-right text-white">
                                    $<span x-text="formatMarketCap(coin.market_cap)"></span>
                                </td>
                                <td class="px-4 py-3 text-right text-white" x-text="coin.volume"></td>
                                <td class="px-4 py-3">
                                    <div class="h-12 w-24 mx-auto">
                                        <canvas :id="'list-chart-' + coin.symbol.replace('-USD', '')"></canvas>
                                    </div>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="flex items-center justify-center space-x-2">
                                        <button @click.stop="addToWatchlist(coin)"
                                                class="text-gray-400 hover:text-yellow-400 transition-colors">
                                            <i class="far fa-star"></i>
                                        </button>
                                        <button @click.stop="openTradeModal(coin)"
                                                class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded-lg transition-all">
                                            Trade
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Loading State -->
        <div x-show="loading" class="flex items-center justify-center py-20">
            <div class="loader"></div>
        </div>
    </div>

    <!-- Trade Modal -->
    <div x-show="tradeModalOpen"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
         @click.self="tradeModalOpen = false">
        <div class="bg-gray-900 rounded-2xl p-6 max-w-md w-full border border-gray-800">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-white">Quick Trade</h3>
                <button @click="tradeModalOpen = false" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div x-show="selectedCoin" class="space-y-4">
                <div class="flex items-center space-x-3 p-3 bg-gray-800/50 rounded-lg">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center bg-gray-500/20">
                        <template x-if="selectedCoin?.icon">
                            <i :class="selectedCoin.icon + ' text-lg'" :style="`color: ${getColorCode(selectedCoin?.color)}`"></i>
                        </template>
                    </div>
                    <div>
                        <div class="text-white font-semibold" x-text="selectedCoin?.name"></div>
                        <div class="text-sm text-gray-400">$<span x-text="selectedCoin?.price"></span></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button class="py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-semibold transition-all">
                        <i class="fas fa-arrow-up mr-2"></i>Buy
                    </button>
                    <button class="py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-all">
                        <i class="fas fa-arrow-down mr-2"></i>Sell
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function marketsApp() {
    return {
        coins: [],
        filteredCoins: [],
        loading: true,
        searchQuery: '',
        selectedCategory: 'all',
        sortBy: 'market_cap',
        viewMode: 'grid',
        tradeModalOpen: false,
        selectedCoin: null,

        getColorCode(color) {
            const colors = {
                'orange': '#f97316',
                'purple': '#a855f7',
                'yellow': '#eab308',
                'blue': '#3b82f6',
                'red': '#ef4444',
                'green': '#10b981',
                'cyan': '#06b6d4',
                'pink': '#ec4899',
                'gray': '#6b7280',
                'teal': '#14b8a6',
                'indigo': '#6366f1'
            };
            return colors[color] || '#6b7280';
        },

        async init() {
            // Load server data immediately
            this.loadServerData();
            
            // Create mini charts after data loads
            this.$nextTick(() => {
                this.createMiniCharts();
            });

            // Try to fetch fresh data
            await this.fetchCoins();

            // Setup WebSocket connection for real-time updates
            this.setupWebSocket();

            // Refresh data every 30 seconds
            setInterval(() => {
                this.fetchCoins();
            }, 30000);
        },

        setupWebSocket() {
            try {
                const ws = new WebSocket('ws://localhost:8080/ws');
                
                ws.onopen = () => {
                    console.log('Markets WebSocket connected');
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'market_update' && data.prices) {
                            this.updatePricesFromWebSocket(data.prices);
                        }
                    } catch (error) {
                        console.log('WebSocket message parse error:', error);
                    }
                };
                
                ws.onerror = () => {
                    console.log('Markets WebSocket error');
                };
                
                ws.onclose = () => {
                    console.log('Markets WebSocket closed, reconnecting...');
                    setTimeout(() => this.setupWebSocket(), 5000);
                };
            } catch (error) {
                console.log('WebSocket connection failed:', error);
            }
        },

        updatePricesFromWebSocket(prices) {
            if (this.coins.length === 0) return;
            
            this.coins.forEach(coin => {
                const symbol = coin.symbol.replace('USDT', '-USD');
                if (prices[symbol]) {
                    coin.price = prices[symbol].price;
                    coin.change_percent = prices[symbol].change_24h;
                }
            });
            
            this.filterCoins();
        },

        async fetchCoins() {
            try {
                // Fetch from our backend with 100+ coins
                const response = await fetch('/api/market-data-extended');
                
                if (response.ok) {
                    const data = await response.json();
                    this.coins = data.cryptos || [];
                } else {
                    throw new Error('Backend API unavailable');
                }

                this.loading = false;
                this.filterCoins();
            } catch (error) {
                console.log('Using server-provided crypto data');
                this.loadServerData();
            }
        },

        loadServerData() {
            // Use data provided by server
            try {
                this.coins = {{ cryptos|tojson|safe }};
                console.log('Loaded', this.coins.length, 'cryptocurrencies');
            } catch (e) {
                console.error('Error loading server data:', e);
                this.loadFallbackData();
            }
            this.loading = false;
            this.filterCoins();
        },

        getCoinName(symbol) {
            const names = {
                'BTC': 'Bitcoin',
                'ETH': 'Ethereum', 
                'SOL': 'Solana',
                'ADA': 'Cardano',
                'LINK': 'Chainlink',
                'UNI': 'Uniswap',
                'MATIC': 'Polygon',
                'XRP': 'Ripple',
                'DOGE': 'Dogecoin',
                'BCH': 'Bitcoin Cash'
            };
            return names[symbol] || symbol;
        },

        getCoinCategories(symbol) {
            const categories = [];
            
            if (['BTC', 'ETH', 'SOL', 'ADA'].includes(symbol)) {
                categories.push('layer1');
            } else if (['MATIC'].includes(symbol)) {
                categories.push('layer2');
            } else if (['DOGE'].includes(symbol)) {
                categories.push('meme');
            } else if (['UNI', 'LINK'].includes(symbol)) {
                categories.push('defi');
            }
            
            return categories;
        },

        loadFallbackData() {
            const fallbackCoins = [
                { name: 'Bitcoin', symbol: 'BTCUSDT', price: 43250, change_percent: 2.45, volume: 25000000000, market_cap: 850000000000 },
                { name: 'Ethereum', symbol: 'ETHUSDT', price: 2580, change_percent: -1.23, volume: 15000000000, market_cap: 310000000000 },
                { name: 'Solana', symbol: 'SOLUSDT', price: 102, change_percent: 4.67, volume: 2500000000, market_cap: 44000000000 },
                { name: 'Cardano', symbol: 'ADAUSDT', price: 0.52, change_percent: -0.85, volume: 800000000, market_cap: 18000000000 },
                { name: 'Chainlink', symbol: 'LINKUSDT', price: 14.25, change_percent: 1.92, volume: 450000000, market_cap: 8400000000 },
                { name: 'Uniswap', symbol: 'UNIUSDT', price: 6.45, change_percent: -2.15, volume: 320000000, market_cap: 3900000000 },
                { name: 'Polygon', symbol: 'MATICUSDT', price: 0.89, change_percent: 3.27, volume: 280000000, market_cap: 8700000000 },
                { name: 'Ripple', symbol: 'XRPUSDT', price: 0.61, change_percent: 0.45, volume: 1200000000, market_cap: 33000000000 },
                { name: 'Dogecoin', symbol: 'DOGEUSDT', price: 0.083, change_percent: -1.65, volume: 650000000, market_cap: 12000000000 },
                { name: 'Bitcoin Cash', symbol: 'BCHUSDT', price: 245, change_percent: 1.38, volume: 180000000, market_cap: 4800000000 }
            ];

            this.coins = fallbackCoins.map(coin => ({
                ...coin,
                change_7d: Math.random() * 30 - 15,
                categories: this.getCoinCategories(coin.symbol.replace('USDT', ''))
            }));

            this.loading = false;
            this.filterCoins();
        },

        filterCoins() {
            let filtered = [...this.coins];

            // Filter by search
            if (this.searchQuery) {
                const query = this.searchQuery.toLowerCase();
                filtered = filtered.filter(coin =>
                    coin.name.toLowerCase().includes(query) ||
                    coin.symbol.toLowerCase().includes(query)
                );
            }

            // Filter by category
            if (this.selectedCategory !== 'all') {
                filtered = filtered.filter(coin =>
                    coin.categories && coin.categories.includes(this.selectedCategory)
                );
            }

            // Sort
            filtered.sort((a, b) => {
                switch(this.sortBy) {
                    case 'price':
                        return b.price - a.price;
                    case 'change':
                        return b.change_percent - a.change_percent;
                    case 'volume':
                        return parseFloat(b.volume) - parseFloat(a.volume);
                    case 'market_cap':
                    default:
                        return parseFloat(b.market_cap) - parseFloat(a.market_cap);
                }
            });

            this.filteredCoins = filtered;

            // Recreate charts after filtering
            this.$nextTick(() => {
                this.createMiniCharts();
            });
        },

        createMiniCharts() {
            this.filteredCoins.forEach(coin => {
                const chartId = this.viewMode === 'grid'
                    ? 'chart-' + coin.symbol.replace('-USD', '')
                    : 'list-chart-' + coin.symbol.replace('-USD', '');

                const canvas = document.getElementById(chartId);
                if (!canvas) return;

                const ctx = canvas.getContext('2d');

                // Generate random chart data
                const data = Array.from({length: 24}, () => Math.random() * 40 + 30);

                // Determine color based on change
                const color = coin.change_percent >= 0 ? '#10b981' : '#ef4444';

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map((_, i) => i),
                        datasets: [{
                            data: data,
                            borderColor: color,
                            backgroundColor: color + '20',
                            borderWidth: 1.5,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: { display: false },
                            y: { display: false }
                        }
                    }
                });
            });
        },

        formatPrice(price) {
            if (price < 0.01) return price.toFixed(6);
            if (price < 1) return price.toFixed(4);
            if (price < 100) return price.toFixed(2);
            return price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        },

        formatMarketCap(mcap) {
            const num = parseFloat(mcap);
            if (num > 1000000000) return (num / 1000000000).toFixed(2) + 'B';
            if (num > 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num > 1000) return (num / 1000).toFixed(2) + 'K';
            return num.toFixed(2);
        },

        addToWatchlist(coin) {
            console.log('Adding to watchlist:', coin);
            // Implement watchlist functionality
        },

        openTradeModal(coin) {
            this.selectedCoin = coin;
            this.tradeModalOpen = true;
        },

        // Watch for changes
        $watch: {
            searchQuery() { this.filterCoins(); },
            selectedCategory() { this.filterCoins(); },
            sortBy() { this.filterCoins(); },
            viewMode() {
                this.$nextTick(() => {
                    this.createMiniCharts();
                });
            }
        }
    }
}
</script>
{% endblock %}
<<<<<<< HEAD

=======
>>>>>>> 96de1d9
