{% extends "base.html" %}

{% block title %}Markets - Sofia V2{% endblock %}

{% block content %}
    <div class="mb-8">
        <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Live Markets</h1>
                <p class="text-gray-600 dark:text-gray-400">Real-time cryptocurrency and equity market data</p>
            </div>
            <div class="flex items-center space-x-4 mt-4 md:mt-0">
                <div id="market-status" class="flex items-center space-x-2">
                    <div id="connection-indicator" class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    <span class="text-sm text-gray-500">Live Data</span>
                </div>
                <button id="refresh-markets" class="btn btn-primary">
                    <i class="fas fa-sync-alt mr-2"></i> Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Market Overview Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="card">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Market Cap</h3>
                    <p class="text-sm text-gray-500">Total Cryptocurrency</p>
                </div>
                <i class="fas fa-globe text-blue-500 text-2xl"></i>
            </div>
            <div class="text-2xl font-bold text-gray-900 dark:text-white">$2.34T</div>
            <div class="text-sm text-success mt-1">+2.8% (24h)</div>
        </div>
        
        <div class="card">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">24h Volume</h3>
                    <p class="text-sm text-gray-500">Total Trading</p>
                </div>
                <i class="fas fa-chart-bar text-purple-500 text-2xl"></i>
            </div>
            <div class="text-2xl font-bold text-gray-900 dark:text-white">$76.5B</div>
            <div class="text-sm text-gray-500 mt-1">Across all exchanges</div>
        </div>
        
        <div class="card">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Active Assets</h3>
                    <p class="text-sm text-gray-500">Tracking</p>
                </div>
                <i class="fas fa-coins text-yellow-500 text-2xl"></i>
            </div>
            <div class="text-2xl font-bold text-gray-900 dark:text-white" id="active-assets-count">150+</div>
            <div class="text-sm text-success mt-1">Real-time updates</div>
        </div>
    </div>

    <!-- Cryptocurrency Markets Table -->
    <div class="card mb-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Cryptocurrency Markets</h2>
            <div class="flex items-center space-x-2">
                <span class="text-sm text-gray-500">Last update:</span>
                <span id="crypto-last-update" class="text-sm font-medium">Loading...</span>
            </div>
        </div>
        
        <!-- Loading skeleton -->
        <div id="crypto-loading" class="space-y-3">
            <div class="skeleton h-4 rounded"></div>
            <div class="skeleton h-4 rounded"></div>
            <div class="skeleton h-4 rounded"></div>
        </div>
        
        <!-- Crypto table -->
        <div id="crypto-table-container" class="hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="sticky top-0 bg-gray-50 dark:bg-gray-800">
                        <tr class="text-left">
                            <th class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-white">Symbol</th>
                            <th class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-white">Price</th>
                            <th class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-white">24h Change</th>
                            <th class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-white">Volume</th>
                            <th class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-white">Market Cap</th>
                        </tr>
                    </thead>
                    <tbody id="crypto-table-body">
                        <!-- Crypto data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Empty state (fallback) -->
        <div id="crypto-empty-state" class="hidden text-center py-12">
            <i class="fas fa-chart-line text-gray-400 text-4xl mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Market Data Loading</h3>
            <p class="text-gray-500">Connecting to data feeds...</p>
        </div>
    </div>

    <!-- Equity Markets Table (BIST) -->
    <div class="card">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">BIST Equity Markets</h2>
            <div class="flex items-center space-x-2">
                <span class="text-sm text-gray-500">Last update:</span>
                <span id="bist-last-update" class="text-sm font-medium">Loading...</span>
            </div>
        </div>
        
        <!-- Loading skeleton -->
        <div id="bist-loading" class="space-y-3">
            <div class="skeleton h-4 rounded"></div>
            <div class="skeleton h-4 rounded"></div>
            <div class="skeleton h-4 rounded"></div>
        </div>
        
        <!-- BIST table -->
        <div id="bist-table-container" class="hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="sticky top-0 bg-gray-50 dark:bg-gray-800">
                        <tr class="text-left">
                            <th class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-white">Symbol</th>
                            <th class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-white">Price (TL)</th>
                            <th class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-white">Change</th>
                            <th class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-white">Volume</th>
                        </tr>
                    </thead>
                    <tbody id="bist-table-body">
                        <!-- BIST data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Empty state (fallback) -->
        <div id="bist-empty-state" class="hidden text-center py-12">
            <i class="fas fa-building text-gray-400 text-4xl mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">BIST Data Loading</h3>
            <p class="text-gray-500">Fetching Istanbul Stock Exchange data...</p>
        </div>
    </div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Markets data management with anti-blank strategy
    let marketSnapshot = {
        crypto: [],
        bist: [],
        lastUpdate: null
    };
    
    let wsConnection = null;
    let wsReconnectAttempts = 0;
    let isInitialized = false;
    
    // Initialize markets page
    async function initializeMarkets() {
        if (isInitialized) return; // Prevent double initialization in StrictMode
        isInitialized = true;
        
        console.log('Initializing markets page...');
        
        // Load initial data
        await loadMarketData();
        
        // Setup WebSocket connection
        setupWebSocket();
        
        // Setup auto-refresh fallback
        setInterval(loadMarketData, 30000); // 30 second fallback
        
        // Setup refresh button
        document.getElementById('refresh-markets').addEventListener('click', loadMarketData);
    }
    
    // Load market data with multiple fallbacks
    async function loadMarketData() {
        try {
            updateConnectionStatus('loading');
            
            // Try multiple data sources in order
            let cryptoData = await fetchCryptoData();
            let bistData = await fetchBISTData();
            
            // Update snapshot (never show empty state)
            if (cryptoData && cryptoData.length > 0) {
                marketSnapshot.crypto = cryptoData;
            }
            
            if (bistData && bistData.length > 0) {
                marketSnapshot.bist = bistData;
            }
            
            marketSnapshot.lastUpdate = new Date();
            
            // Render data (always show something)
            renderCryptoTable(marketSnapshot.crypto);
            renderBISTTable(marketSnapshot.bist);
            
            updateConnectionStatus('connected');
            updateLastUpdateTime();
            
        } catch (error) {
            console.error('Failed to load market data:', error);
            updateConnectionStatus('error');
            
            // Show snapshot if available, otherwise show loading state
            if (marketSnapshot.crypto.length > 0 || marketSnapshot.bist.length > 0) {
                renderCryptoTable(marketSnapshot.crypto);
                renderBISTTable(marketSnapshot.bist);
            } else {
                showEmptyStates();
            }
        }
    }
    
    // Fetch cryptocurrency data
    async function fetchCryptoData() {
        try {
            const response = await fetch('/api/crypto-prices');
            const data = await response.json();
            
            if (data && typeof data === 'object') {
                return Object.entries(data).map(([symbol, info]) => ({
                    symbol: symbol,
                    name: info.name || symbol,
                    price: info.price || 0,
                    change: info.change || 0,
                    change_percent: info.change_percent || 0,
                    volume: info.volume || '0',
                    market_cap: info.market_cap || 'N/A'
                }));
            }
            
            return [];
        } catch (error) {
            console.log('Crypto API failed, using fallback data');
            return generateFallbackCryptoData();
        }
    }
    
    // Fetch BIST data
    async function fetchBISTData() {
        try {
            const response = await fetch('/api/bist/real-data');
            if (response.ok) {
                const data = await response.json();
                return data.stocks || [];
            }
            
            // Fallback to alternative endpoint
            const fallbackResponse = await fetch('/bist');
            if (fallbackResponse.ok) {
                // Parse HTML response for BIST data (simplified)
                return await parseBISTFromHTML(fallbackResponse);
            }
            
            return [];
        } catch (error) {
            console.log('BIST API failed, using last snapshot');
            return marketSnapshot.bist; // Use existing snapshot
        }
    }
    
    // Generate fallback crypto data
    function generateFallbackCryptoData() {
        const cryptoSymbols = [
            { symbol: 'BTC/USDT', name: 'Bitcoin', basePrice: 67500 },
            { symbol: 'ETH/USDT', name: 'Ethereum', basePrice: 3450 },
            { symbol: 'BNB/USDT', name: 'Binance', basePrice: 245 },
            { symbol: 'XRP/USDT', name: 'Ripple', basePrice: 0.52 },
            { symbol: 'ADA/USDT', name: 'Cardano', basePrice: 0.34 },
            { symbol: 'SOL/USDT', name: 'Solana', basePrice: 98 },
            { symbol: 'DOGE/USDT', name: 'Dogecoin', basePrice: 0.067 },
            { symbol: 'DOT/USDT', name: 'Polkadot', basePrice: 4.12 },
            { symbol: 'MATIC/USDT', name: 'Polygon', basePrice: 0.78 },
            { symbol: 'AVAX/USDT', name: 'Avalanche', basePrice: 19.5 }
        ];
        
        return cryptoSymbols.map(coin => {
            const variation = (Math.random() - 0.5) * 0.1; // Â±5% variation
            const price = coin.basePrice * (1 + variation);
            const change_percent = variation * 100;
            
            return {
                symbol: coin.symbol,
                name: coin.name,
                price: price,
                change: price * variation,
                change_percent: change_percent,
                volume: `${(Math.random() * 50 + 10).toFixed(1)}B`,
                market_cap: `${(Math.random() * 500 + 100).toFixed(1)}B`
            };
        });
    }
    
    // Render crypto table
    function renderCryptoTable(cryptoData) {
        const container = document.getElementById('crypto-table-container');
        const loading = document.getElementById('crypto-loading');
        const emptyState = document.getElementById('crypto-empty-state');
        const tbody = document.getElementById('crypto-table-body');
        
        if (!cryptoData || cryptoData.length === 0) {
            container.classList.add('hidden');
            loading.classList.add('hidden');
            emptyState.classList.remove('hidden');
            return;
        }
        
        // Hide loading and empty state
        loading.classList.add('hidden');
        emptyState.classList.add('hidden');
        container.classList.remove('hidden');
        
        // Clear and populate table
        tbody.innerHTML = '';
        
        cryptoData.forEach(crypto => {
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800';
            
            const changeClass = crypto.change_percent >= 0 ? 'text-success' : 'text-danger';
            const changeSign = crypto.change_percent >= 0 ? '+' : '';
            
            row.innerHTML = `
                <td class="px-4 py-3">
                    <div class="flex items-center">
                        <div>
                            <div class="font-medium text-gray-900 dark:text-white">${crypto.symbol}</div>
                            <div class="text-sm text-gray-500">${crypto.name}</div>
                        </div>
                    </div>
                </td>
                <td class="px-4 py-3">
                    <div class="font-mono text-gray-900 dark:text-white">$${crypto.price.toFixed(crypto.price < 1 ? 6 : 2)}</div>
                </td>
                <td class="px-4 py-3">
                    <div class="${changeClass} font-medium">${changeSign}${crypto.change_percent.toFixed(2)}%</div>
                    <div class="text-sm text-gray-500">${changeSign}$${Math.abs(crypto.change).toFixed(2)}</div>
                </td>
                <td class="px-4 py-3">
                    <div class="text-gray-900 dark:text-white">${crypto.volume}</div>
                </td>
                <td class="px-4 py-3">
                    <div class="text-gray-900 dark:text-white">${crypto.market_cap}</div>
                </td>
            `;
            
            tbody.appendChild(row);
        });
        
        // Update last update time
        document.getElementById('crypto-last-update').textContent = new Date().toLocaleTimeString();
    }
    
    // Render BIST table  
    function renderBISTTable(bistData) {
        const container = document.getElementById('bist-table-container');
        const loading = document.getElementById('bist-loading');
        const emptyState = document.getElementById('bist-empty-state');
        const tbody = document.getElementById('bist-table-body');
        
        if (!bistData || bistData.length === 0) {
            container.classList.add('hidden');
            loading.classList.add('hidden');
            emptyState.classList.remove('hidden');
            return;
        }
        
        // Hide loading and empty state
        loading.classList.add('hidden');
        emptyState.classList.add('hidden');
        container.classList.remove('hidden');
        
        // Clear and populate table
        tbody.innerHTML = '';
        
        bistData.slice(0, 20).forEach(stock => { // Show top 20
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800';
            
            const changeClass = stock.change >= 0 ? 'text-success' : 'text-danger';
            const changeSign = stock.change >= 0 ? '+' : '';
            
            row.innerHTML = `
                <td class="px-4 py-3">
                    <div class="font-medium text-gray-900 dark:text-white">${stock.symbol}</div>
                </td>
                <td class="px-4 py-3">
                    <div class="font-mono text-gray-900 dark:text-white">${stock.price.toFixed(2)} TL</div>
                </td>
                <td class="px-4 py-3">
                    <div class="${changeClass} font-medium">${changeSign}${stock.change.toFixed(2)}%</div>
                </td>
                <td class="px-4 py-3">
                    <div class="text-gray-900 dark:text-white">${stock.volume || 'N/A'}</div>
                </td>
            `;
            
            tbody.appendChild(row);
        });
        
        // Update last update time  
        document.getElementById('bist-last-update').textContent = new Date().toLocaleTimeString();
    }
    
    // Setup WebSocket connection with reconnection
    function setupWebSocket() {
        try {
            wsConnection = new WebSocket('ws://localhost:8005/ws');
            
            wsConnection.onopen = () => {
                console.log('Markets WebSocket connected');
                wsReconnectAttempts = 0;
                updateConnectionStatus('connected');
            };
            
            wsConnection.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketData(data);
                } catch (error) {
                    console.error('WebSocket data error:', error);
                }
            };
            
            wsConnection.onclose = () => {
                console.log('Markets WebSocket disconnected');
                updateConnectionStatus('disconnected');
                
                // Exponential backoff reconnection
                setTimeout(() => {
                    if (wsReconnectAttempts < 5) {
                        wsReconnectAttempts++;
                        setupWebSocket();
                    }
                }, Math.min(1000 * Math.pow(2, wsReconnectAttempts), 30000));
            };
            
            wsConnection.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateConnectionStatus('error');
            };
            
        } catch (error) {
            console.error('Failed to setup WebSocket:', error);
            updateConnectionStatus('error');
        }
    }
    
    // Handle WebSocket data
    function handleWebSocketData(data) {
        if (data.type === 'crypto_update') {
            marketSnapshot.crypto = data.data;
            renderCryptoTable(data.data);
        } else if (data.type === 'bist_update') {
            marketSnapshot.bist = data.data;
            renderBISTTable(data.data);
        }
    }
    
    // Update connection status
    function updateConnectionStatus(status) {
        const indicator = document.getElementById('connection-indicator');
        const statusText = indicator.nextElementSibling;
        
        switch (status) {
            case 'connected':
                indicator.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
                statusText.textContent = 'Live Data';
                break;
            case 'loading':
                indicator.className = 'w-3 h-3 bg-yellow-500 rounded-full animate-spin';
                statusText.textContent = 'Loading...';
                break;
            case 'disconnected':
                indicator.className = 'w-3 h-3 bg-yellow-500 rounded-full';
                statusText.textContent = 'Reconnecting...';
                break;
            case 'error':
                indicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                statusText.textContent = 'Using Cache';
                break;
        }
    }
    
    // Update last update time
    function updateLastUpdateTime() {
        const time = new Date().toLocaleTimeString();
        document.getElementById('crypto-last-update').textContent = time;
        document.getElementById('bist-last-update').textContent = time;
    }
    
    // Show empty states
    function showEmptyStates() {
        document.getElementById('crypto-loading').classList.add('hidden');
        document.getElementById('crypto-table-container').classList.add('hidden');
        document.getElementById('crypto-empty-state').classList.remove('hidden');
        
        document.getElementById('bist-loading').classList.add('hidden');
        document.getElementById('bist-table-container').classList.add('hidden');
        document.getElementById('bist-empty-state').classList.remove('hidden');
    }
    
    // Parse BIST data from HTML response (fallback)
    async function parseBISTFromHTML(response) {
        // Simplified - in production would parse actual HTML
        return [];
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeMarkets);
    } else {
        initializeMarkets();
    }
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (wsConnection) {
            wsConnection.close();
        }
    });
</script>
{% endblock %}